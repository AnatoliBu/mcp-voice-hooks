# 1.1 Electron Project Setup

## Статус: ✅ Завершено

## Описание

Базовая настройка Electron проекта с интеграцией Vite и TypeScript для трех процессов: main, preload, и renderer.

## Выполненные задачи

### 1. Установка зависимостей

Установлены следующие пакеты:
- `electron` - фреймворк для создания desktop приложений
- `vite` - сборщик для разработки и продакшена
- `electron-builder` - сборка дистрибутивов
- `vite-plugin-electron` - интеграция Electron с Vite
- `vite-plugin-electron-renderer` - плагин для renderer process

```bash
npm install --save-dev electron vite electron-builder vite-plugin-electron vite-plugin-electron-renderer
```

### 2. Структура проекта

Создана следующая структура директорий:

```
electron/
├── main/                 # Main process (Node.js)
│   ├── index.ts         # Точка входа main process
│   └── tsconfig.json    # TypeScript config для main
├── preload/             # Preload scripts
│   ├── index.ts         # IPC bridge
│   ├── types.ts         # Type definitions
│   └── tsconfig.json    # TypeScript config для preload
├── renderer/            # Renderer process (Browser)
│   ├── index.html       # HTML template
│   ├── main.ts          # Renderer entry point
│   ├── styles.css       # Базовые стили
│   └── (tsconfig наследуется от корневого)
└── tsconfig.json        # Общий config для electron/
```

### 3. TypeScript конфигурация

#### electron/tsconfig.json
Базовый конфиг для всей electron/ директории:
```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "composite": true,
    "noEmit": false,
    "outDir": "../dist-electron"
  },
  "include": ["**/*"]
}
```

#### electron/main/tsconfig.json
Специфичный для main process (CommonJS):
```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "module": "CommonJS",
    "target": "ES2020",
    "lib": ["ES2020"],
    "types": ["node"]
  },
  "include": ["./**/*"]
}
```

#### electron/preload/tsconfig.json
Для preload scripts (CommonJS + DOM):
```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "module": "CommonJS",
    "target": "ES2020",
    "lib": ["ES2020", "DOM"],
    "types": ["node"]
  },
  "include": ["./**/*"]
}
```

### 4. Main Process (electron/main/index.ts)

Создан main process с базовым окном overlay:

**Основные характеристики окна:**
- Frameless (без рамки)
- Transparent (прозрачный фон)
- Always on top (всегда поверх других окон)
- Skip taskbar (не показывается в панели задач)
- Non-resizable (нельзя изменить размер)

**Конфигурация безопасности:**
- `contextIsolation: true` - изоляция контекста
- `nodeIntegration: false` - отключен прямой доступ к Node.js
- `sandbox: true` - включен sandbox режим

### 5. Preload Script с Type-Safe IPC Bridge

#### electron/preload/types.ts
Определяет типы для `window.electronAPI`:

```typescript
export interface ElectronAPI {
  platform: NodeJS.Platform;
}

declare global {
  interface Window {
    electronAPI: ElectronAPI;
  }
}
```

#### electron/preload/index.ts
Использует `contextBridge` для безопасного expose API:

```typescript
import { contextBridge } from 'electron';
import type { ElectronAPI } from './types';

const api: ElectronAPI = {
  platform: process.platform
};

contextBridge.exposeInMainWorld('electronAPI', api);
```

### 6. Renderer Process

Создан базовый renderer с:
- **index.html** - HTML template с overlay container
- **styles.css** - Стили для overlay (прозрачный фон, backdrop-filter)
- **main.ts** - Entry point для renderer логики

### 7. Vite Configuration (vite.config.ts)

Настроен Vite для сборки всех трех процессов:

```typescript
export default defineConfig({
  plugins: [
    electron([
      {
        // Main process
        entry: 'electron/main/index.ts',
        vite: {
          build: {
            outDir: 'dist-electron/main',
            lib: { formats: ['cjs'] }
          }
        }
      },
      {
        // Preload script
        entry: 'electron/preload/index.ts',
        onstart(options) {
          options.reload(); // Hot reload preload
        }
      }
    ]),
    renderer()
  ],
  root: 'electron/renderer',
  server: { port: 5173 }
});
```

### 8. Package.json Updates

#### Обновлен main entry point:
```json
"main": "dist-electron/main/index.js"
```

#### Добавлены новые scripts:
```json
"electron:dev": "vite",
"electron:build": "vite build && electron-builder",
"electron:preview": "vite build && electron dist-electron/main/index.js"
```

#### Добавлена конфигурация electron-builder:
```json
"build": {
  "appId": "com.mcp-voice-hooks.app",
  "productName": "MCP Voice Hooks",
  "files": ["dist-electron/**/*", "package.json"],
  "mac": { "target": ["dmg", "zip"] },
  "win": { "target": ["nsis", "portable"] },
  "linux": { "target": ["AppImage", "deb"] }
}
```

### 9. .gitignore Updates

Добавлены новые директории для игнорирования:
```
dist-electron/
release/
```

## Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                   Electron App                           │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐    ┌──────────────┐   ┌────────────┐ │
│  │ Main Process │───►│   Preload    │──►│  Renderer  │ │
│  │  (Node.js)   │    │  (Bridge)    │   │ (Browser)  │ │
│  └──────────────┘    └──────────────┘   └────────────┘ │
│        │                    │                    │       │
│   BrowserWindow      contextBridge           DOM API    │
│   IPC Handlers       Type Safety         Web Speech API │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

## Следующие шаги (Story 1.2)

1. Window Manager & Overlay
   - Управление позицией окна
   - Показ/скрытие overlay
   - Drag & drop позиционирование

## Команды для работы

```bash
# Development
npm run electron:dev

# Build production
npm run electron:build

# Preview build
npm run electron:preview
```

## Ссылки

- [Electron Documentation](https://www.electronjs.org/docs/latest/)
- [Vite Plugin Electron](https://github.com/electron-vite/vite-plugin-electron)
- [Electron Security](https://www.electronjs.org/docs/latest/tutorial/security)
