# Story 1.10: Build & Distribution

**Effort:** M (3-5 дней) | **Complexity:** ⭐⭐⭐ (3/5)

## Overview

Настройка системы сборки и дистрибуции Electron приложения для macOS, Windows и Linux с автоматизацией через GitHub Actions.

## Status

✅ **COMPLETED** - Все задачи выполнены

## Key Features

1. **electron-builder Configuration** ✅
   - Multi-platform builds (macOS, Windows, Linux)
   - Multiple architectures (x64, arm64, universal)
   - Output formats: DMG, ZIP, NSIS, Portable, AppImage, DEB

2. **Application Icons** ✅
   - SVG source design with microphone and sound waves
   - Automated conversion script (`npm run build:icons`)
   - Platform-specific formats:
     - macOS: `.icns` (with all retina sizes)
     - Windows: `.ico` (multi-resolution)
     - Linux: `.png` (512x512)

3. **GitHub Actions CI/CD** ✅
   - Matrix build on all 3 platforms
   - Automated release creation
   - Artifact upload and distribution
   - Code signing support (optional)

4. **Code Signing Setup** ✅
   - macOS: Developer ID + Notarization support
   - Windows: Certificate-based signing
   - Environment variable configuration
   - Detailed documentation

## Implementation Details

### Package.json Scripts

```json
{
  "build:icons": "bash scripts/build-icons.sh",
  "electron:dev": "vite",
  "electron:build": "vite build && electron-builder",
  "electron:build:mac": "vite build && electron-builder --mac",
  "electron:build:win": "vite build && electron-builder --win",
  "electron:build:linux": "vite build && electron-builder --linux",
  "electron:preview": "vite build && electron dist-electron/main/index.js"
}
```

### electron-builder Configuration

Located in `package.json` under `"build"` key:

- **appId**: `com.mcp-voice-hooks.app`
- **productName**: `MCP Voice Hooks`
- **Output**: `release/` directory
- **Build Resources**: `build/` directory

Platform-specific settings:
- **macOS**: DMG + ZIP, universal binaries, hardened runtime, entitlements
- **Windows**: NSIS installer + portable, per-user installation
- **Linux**: AppImage + DEB packages

### GitHub Actions Workflow

File: `.github/workflows/build-release.yml`

**Triggers:**
- Git tags matching `v*.*.*` (e.g., `v1.0.0`)
- Manual workflow dispatch

**Jobs:**
1. **Build Matrix**: Runs on macOS, Windows, Ubuntu
2. **Platform-specific builds** with artifact upload
3. **Release**: Creates GitHub release with all artifacts

### Icon Assets

**Source Files:**
- `build/icons/icon-design.svg` - Master SVG (512x512)
- `build/icons/ICONS-README.md` - Conversion guide

**Generated Icons:**
- `build/icons/icon.icns` (macOS)
- `build/icons/icon.ico` (Windows)
- `build/icons/icon.png` (Linux)

**Build Script:**
- `scripts/build-icons.sh` - Automated conversion using ImageMagick

### Code Signing

See `docs/CODE_SIGNING.md` for detailed guide.

**macOS Secrets (optional):**
- `MAC_CERT_BASE64`: Developer ID certificate (base64)
- `MAC_CERT_PASSWORD`: Certificate password
- `APPLE_ID`: Apple ID for notarization
- `APPLE_ID_PASSWORD`: App-specific password
- `APPLE_TEAM_ID`: Apple Developer Team ID

**Windows Secrets (optional):**
- `WIN_CERT_BASE64`: Code signing certificate (base64)
- `WIN_CERT_PASSWORD`: Certificate password

**Note**: App builds successfully without code signing, but will show security warnings to users.

## File Structure

```
mcp-voice-hooks/
├── .github/
│   └── workflows/
│       ├── build-release.yml      # New: Multi-platform build workflow
│       └── publish.yml            # Existing: NPM publish
├── build/
│   ├── icons/
│   │   ├── icon-design.svg        # New: Master icon design
│   │   ├── icon.icns              # Generated: macOS icon
│   │   ├── icon.ico               # Generated: Windows icon
│   │   ├── icon.png               # Generated: Linux icon
│   │   ├── ICONS-README.md        # New: Icon build guide
│   │   └── tray-icon-*.png        # Existing: System tray icons
│   └── entitlements.mac.plist     # New: macOS entitlements
├── docs/
│   ├── stories/
│   │   └── 1.10.build-distribution.md  # This file
│   └── CODE_SIGNING.md            # New: Code signing guide
├── scripts/
│   └── build-icons.sh             # New: Icon generation script
├── package.json                   # Updated: Build config + scripts
└── vite.config.ts                 # Existing: Vite configuration
```

## Testing

### Local Build Test

```bash
# Install dependencies
npm install

# Build icons (requires ImageMagick)
npm run build:icons

# Build for current platform
npm run electron:build

# Build for specific platform
npm run electron:build:mac
npm run electron:build:win
npm run electron:build:linux

# Preview without packaging
npm run electron:preview
```

### GitHub Actions Test

1. Create a test tag:
   ```bash
   git tag v1.0.0-test
   git push origin v1.0.0-test
   ```

2. Monitor workflow at: `https://github.com/johnmatthewtennant/mcp-voice-hooks/actions`

3. Check artifacts and draft release

## Dependencies Added

```json
{
  "devDependencies": {
    "electron": "^33.3.1",
    "electron-builder": "^25.1.8",
    "vite": "^6.0.7",
    "vite-plugin-electron": "^0.30.5",
    "vite-plugin-electron-renderer": "^0.14.6"
  }
}
```

## Release Process

### 1. Prepare Release

- Update version in `package.json`
- Update CHANGELOG or release notes
- Commit changes: `git commit -m "chore: prepare v1.0.0"`

### 2. Create Tag

```bash
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

### 3. GitHub Actions

- Workflow automatically triggers on tag push
- Builds on macOS, Windows, Linux
- Uploads artifacts
- Creates draft GitHub release

### 4. Publish Release

- Go to GitHub Releases
- Review draft release
- Edit release notes if needed
- Publish release

### 5. Users Download

Users can download from:
- **GitHub Releases**: Platform-specific installers
- **Auto-update**: Enabled via electron-builder (future enhancement)

## Troubleshooting

### Build fails with "icons not found"

```bash
# Generate icons first
npm run build:icons

# Or build without icons (unsigned)
CSC_IDENTITY_AUTO_DISCOVERY=false npm run electron:build
```

### ImageMagick not installed

Install ImageMagick:
```bash
# macOS
brew install imagemagick

# Ubuntu/Debian
sudo apt-get install imagemagick

# Windows (Chocolatey)
choco install imagemagick
```

### Code signing errors

- For testing: Build unsigned (see `docs/CODE_SIGNING.md`)
- For production: Set up certificates and secrets
- macOS: Check certificates in Keychain Access
- Windows: Verify `.pfx` file and password

### GitHub Actions fails

- Check workflow logs at: Actions tab
- Verify secrets are set correctly
- Ensure all dependencies are in `package.json`

## Known Limitations

1. **Code signing**: Optional - apps work but show warnings
2. **Auto-update**: Not implemented yet (future enhancement)
3. **macOS notarization**: Requires Apple Developer account ($99/year)
4. **Icon quality**: Generated icons work but could be refined by designer

## Future Enhancements

- [ ] Auto-update functionality
- [ ] Professional icon design
- [ ] Crash reporting integration
- [ ] Analytics/telemetry
- [ ] Store submission (Mac App Store, Windows Store)
- [ ] Linux packaging (Snap, Flatpak)

## Documentation

- **Code Signing**: `docs/CODE_SIGNING.md`
- **Icon Building**: `build/icons/ICONS-README.md`
- **electron-builder**: https://www.electron.build/
- **GitHub Actions**: `.github/workflows/build-release.yml`

## Success Criteria

✅ All criteria met:

- [x] electron-builder configured for all platforms
- [x] Application icons created and integrated
- [x] GitHub Actions workflow building on all platforms
- [x] Code signing infrastructure documented
- [x] Local build tested successfully
- [x] Documentation complete

## Dependencies

**Blocked by:** Stories 1.1-1.9 (Electron app must be functional)

**Blocks:** None (final story)

**Related:**
- Story 1.1: Electron setup provides base structure
- Story 1.2: Window manager needed for app functionality
- Story 1.9: System tray integration completes UI

## Notes

- All configuration is in `package.json` - no separate electron-builder config file
- Icons use automated generation - can be replaced with professional designs later
- Code signing is optional but recommended for production
- GitHub Actions workflow supports manual triggers for testing
- Build artifacts are uploaded as workflow artifacts (7-day retention)
